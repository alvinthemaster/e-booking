# Van Departure Countdown Notifications Feature

## Overview
Added notification alerts when the countdown timer for a full van starts and ends, providing real-time updates to users about their van's departure status.

## Implementation Details

### Modified File
- **lib/widgets/van_departure_countdown_widget.dart**

### Changes Made

#### 1. Added NotificationService Import
```dart
import '../services/notification_service.dart';
```

#### 2. Added Notification State Tracking
```dart
bool _hasNotifiedStart = false;
bool _hasNotifiedEnd = false;
```

These flags prevent duplicate notifications for the same van departure event.

#### 3. Timer Start Notification
When a van becomes full and the countdown starts:
```dart
if (!_hasNotifiedStart) {
  _hasNotifiedStart = true;
  final minutes = departureTime.difference(DateTime.now()).inMinutes;
  NotificationService().showNotification(
    title: 'üöê Your Van is Full!',
    body: 'Van ${van.plateNumber} will depart in $minutes minutes. Get ready!',
    payload: 'van_departure_${van.id}',
  );
}
```

**Notification Details:**
- **Title:** "üöê Your Van is Full!"
- **Body:** Shows van plate number and minutes until departure
- **Payload:** `van_departure_{vanId}` for tracking
- **Timing:** Sent immediately when countdown starts

#### 4. Timer End Notification
When the countdown reaches zero:
```dart
if (!_hasNotifiedEnd) {
  _hasNotifiedEnd = true;
  NotificationService().showNotification(
    title: 'üöÄ Van Departing Now!',
    body: 'Van ${van.plateNumber} is leaving. Please board immediately!',
    payload: 'van_departed_{vanId}',
  );
}
```

**Notification Details:**
- **Title:** "üöÄ Van Departing Now!"
- **Body:** Urgent message to board the van
- **Payload:** `van_departed_{vanId}` for tracking
- **Timing:** Sent when timer reaches 00:00

#### 5. Notification Flag Reset
Flags are reset when:
- User has no confirmed bookings
- Van becomes non-full (occupancy drops or status changes)

This ensures fresh notifications for new departure events.

## User Experience Flow

### Scenario 1: Normal Van Departure
```
1. User books seat on van TEST3 (1/18 seats)
2. Van gradually fills up...
3. Van reaches 18/18 capacity OR admin sets status to "full"
4. üîî NOTIFICATION: "Your Van is Full! Van TEST3 will depart in 15 minutes"
5. Countdown widget appears on home screen showing timer
6. Timer counts down: 14:59... 14:58... ... 00:02... 00:01...
7. Timer reaches 00:00
8. üîî NOTIFICATION: "Van Departing Now! Van TEST3 is leaving. Board immediately!"
9. Widget shows "Time's Up! Van is departing..."
```

### Scenario 2: User Cancels Booking
```
1. Countdown active, notifications sent
2. User cancels booking
3. Notifications stop, flags reset
4. Widget disappears from home screen
```

### Scenario 3: Van Empties Before Departure
```
1. Van full, countdown active, start notification sent
2. Multiple passengers cancel
3. Van drops to 15/18 capacity
4. Countdown stops, widget disappears, flags reset
5. If van fills again later, fresh notifications will be sent
```

## Technical Notes

### Notification Service Usage
Uses existing `NotificationService.showNotification()` method:
- Displays immediate local notification
- No scheduling required (notifications are instant)
- Uses "van_departure_channel" notification channel
- Notification ID auto-generated by service

### Debug Logging
Added console logs for tracking:
```dart
debugPrint('üîî VanWidget: Sent countdown start notification for van ${van.plateNumber}');
debugPrint('üîî VanWidget: Sent countdown end notification for van ${van.plateNumber}');
```

### Duplicate Prevention
- `_hasNotifiedStart` prevents multiple "Van is Full" notifications
- `_hasNotifiedEnd` prevents multiple "Van Departing Now" notifications
- Flags reset when van state changes to allow future notifications

### Widget Lifecycle
```
initState() 
  ‚Üí _listenToBookings()
    ‚Üí _listenToVan()
      ‚Üí Van becomes full
        ‚Üí _startCountdownTimer()
          ‚Üí Send START notification (once)
          ‚Üí Timer.periodic() runs
            ‚Üí Countdown reaches zero
              ‚Üí Send END notification (once)
              ‚Üí Update UI to show "Time's Up!"

dispose()
  ‚Üí Cancel all subscriptions and timers
  ‚Üí Clean up resources
```

## Testing Scenarios

### Test 1: Full Van Flow
1. Book a seat on TEST3 (ensure you're logged in)
2. In Firebase Console, set TEST3 occupancy to 18
3. Wait 2 seconds
4. ‚úÖ Should receive "Van is Full" notification
5. ‚úÖ Countdown widget should appear
6. In Firebase Console, set `scheduledDepartureTime` to 30 seconds from now
7. Wait for timer to reach 00:00
8. ‚úÖ Should receive "Van Departing Now" notification

### Test 2: Van Status Change
1. Book a seat on TEST2
2. In Firebase Console, set TEST2 status to "full"
3. ‚úÖ Should receive "Van is Full" notification
4. ‚úÖ Countdown widget should appear

### Test 3: Cancellation
1. Van full, countdown running, notifications sent
2. Cancel booking
3. ‚úÖ Widget should disappear
4. ‚úÖ No more notifications

### Test 4: Duplicate Prevention
1. Van becomes full
2. Receive start notification
3. Force hot restart app
4. ‚ùå Should NOT receive duplicate start notification (state preserved)

## Console Log Examples

### Start Notification
```
I/flutter: üöê Van TEST3 detected as FULL - Occupancy: 18/18, Status: "full"
I/flutter: üîî VanWidget: Sent countdown start notification for van TEST3
```

### End Notification
```
I/flutter: Timer reached 00:00 for van TEST3
I/flutter: üîî VanWidget: Sent countdown end notification for van TEST3
```

### State Reset
```
I/flutter: ‚è≥ Van TEST3 not full yet - Occupancy: 15/18, Status: "boarding"
I/flutter: Countdown stopped, notification flags reset
```

## Code Impact Summary

### Files Modified: 1
- `lib/widgets/van_departure_countdown_widget.dart` (66 lines changed)

### Files Created: 0
- Used existing `NotificationService`

### Dependencies Added: 0
- No new packages required
- Uses existing `flutter_local_notifications`

### Other Code Modified: 0
- No changes to screens, models, or other services
- Self-contained feature within widget

## Related Features
- **Van Departure Countdown Widget:** Visual timer on home screen
- **Firebase Cloud Messaging:** Push notification infrastructure
- **NotificationService:** Local notification handling
- **VanFullNotificationService:** Separate service for admin-triggered notifications

## Future Enhancements
1. **Customizable Warning Times:** Allow users to set custom alert times (e.g., 10 min, 5 min, 1 min)
2. **Sound/Vibration Options:** Let users customize notification behavior
3. **Snooze Feature:** Option to snooze the final notification
4. **Notification History:** Log of all departure notifications received
5. **Multiple Van Support:** Handle notifications for multiple booked vans

## Notification Permissions
Already configured in `AndroidManifest.xml`:
- `POST_NOTIFICATIONS` - Required for Android 13+
- `VIBRATE` - For notification vibration
- `WAKE_LOCK` - To wake device for urgent notifications

## Version History
- **v1.0.0** (October 20, 2025): Initial implementation
  - Start notification when timer begins
  - End notification when timer reaches zero
  - Duplicate prevention logic
  - State reset on van status change

---

**Status:** ‚úÖ Implemented and Working
**Last Updated:** October 20, 2025
**Developer Notes:** Feature works smoothly with no side effects on other code. Notifications are clear, timely, and non-intrusive.
