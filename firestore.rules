rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== PUBLIC READ ACCESS (No Authentication Required) =====
    // These are needed for the QR confirmation web page and general app functionality
    
    // Routes - Public read access for route information
    match /routes/{routeId} {
      allow read: if true;
      allow write: if request.auth != null; // Only authenticated users can write
    }
    
    // Vans - Public read and limited write access for occupancy updates
    match /vans/{vanId} {
      allow read: if true;
      allow update: if true; // Allow occupancy updates from both app and web
      allow create, delete: if request.auth != null; // Only authenticated users can create/delete
    }
    
    // Bookings - Mixed access for ticket confirmation and user management
    match /bookings/{bookingId} {
      // Public read for QR confirmation web page
      allow read: if true;
      
      // Public update for conductor confirmation (web page)
      allow update: if true;
      
      // Authenticated users can create bookings
      allow create: if request.auth != null;
      
      // Users can delete their own bookings
      allow delete: if request.auth != null && 
                    request.auth.uid == resource.data.userId;
    }
    
    // Tickets - For QR confirmation system
    match /tickets/{ticketId} {
      allow read: if true; // Public read for confirmation
      allow write: if true; // Public write for confirmation updates
    }
    
    // ===== AUTHENTICATED USER ACCESS =====
    
    // Users can manage their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && 
                         request.auth.uid == userId;
    }
    
    // Schedules - Read access for authenticated users
    match /schedules/{scheduleId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Allow authenticated users to write schedules
    }
    
    // ===== ADMIN ACCESS =====
    // Admin users can access everything (using custom claims)
    match /{document=**} {
      allow read, write: if request.auth != null && 
                         request.auth.token.admin == true;
    }
    
    // ===== FALLBACK RULES =====
    // Allow authenticated users basic read access to collections
    match /{collection}/{document} {
      allow read: if request.auth != null;
    }
  }
}