rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== PUBLIC READ ACCESS (No Authentication Required) =====
    // These are needed for the QR confirmation web page and general app functionality
    
    // Routes - Public read access for route information
    match /routes/{routeId} {
      allow read: if true;
      allow write: if request.auth != null; // Only authenticated users can write
    }
    
    // Vans - Public read and limited write access for occupancy updates
    match /vans/{vanId} {
      allow read: if true;
      allow update: if true; // Allow occupancy updates from both app and web
      allow create, delete: if request.auth != null; // Only authenticated users can create/delete
    }
    
    // Bookings - Mixed access for ticket confirmation and user management
    match /bookings/{bookingId} {
      // Public read for QR confirmation web page
      allow read: if true;
      
      // Public update for conductor confirmation (web page)
      allow update: if true;
      
      // Authenticated users can create bookings
      allow create: if request.auth != null;
      
      // Users can delete their own bookings
      allow delete: if request.auth != null && 
                    request.auth.uid == resource.data.userId;
    }
    
    // Tickets - For QR confirmation system
    match /tickets/{ticketId} {
      allow read: if true; // Public read for confirmation
      allow write: if true; // Public write for confirmation updates
    }
    
    // ===== AUTHENTICATED USER ACCESS =====
    
    // Users can manage their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && 
                         request.auth.uid == userId;
    }
    
    // Schedules - Read access for authenticated users
    match /schedules/{scheduleId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Allow authenticated users to write schedules
    }
    
    // ===== VAN RENTAL REQUESTS =====
    // Van Rental Requests - Users can read and write their own requests
    match /van_rental_requests/{requestId} {
      // Allow reading a single document only if it belongs to the user
      allow get: if request.auth != null && 
                   (resource == null || request.auth.uid == resource.data.userId);
      
      // Allow listing (collection queries) for authenticated users
      // Needed for cross-collection availability check (query by status/vanId)
      allow list: if request.auth != null;
      
      // Allow authenticated users to create rental requests
      allow create: if request.auth != null && 
                     request.auth.uid == request.resource.data.userId;
      
      // Allow authenticated users to update their own rental requests
      allow update: if request.auth != null && 
                     request.auth.uid == resource.data.userId &&
                     request.auth.uid == request.resource.data.userId;
      
      // Allow authenticated users to delete their own rental requests
      allow delete: if request.auth != null && 
                     request.auth.uid == resource.data.userId;
    }
    
    // ===== RENTAL VANS (AVAILABLE FOR RENT) =====
    // Rental Vans - Public read access for browsing, admin write access
    match /rental_vans/{vanId} {
      // Public read - anyone can browse available vans (like routes/vans collections)
      allow read: if true;
      
      // Only admins can create, update, or delete rental vans
      allow write: if request.auth != null &&
                    request.auth.token.admin == true;
    }
    
    // ===== DOCUMENT DELIVERIES =====
    // Authenticated users can create and read their own document delivery requests.
    // Admins have full access via the wildcard rule below.
    match /document_deliveries/{deliveryId} {
      // Users can read any delivery they own
      allow get: if request.auth != null &&
                   (resource == null || request.auth.uid == resource.data.userId);
      
      // Users can list their own deliveries (queries filtered by userId)
      allow list: if request.auth != null;
      
      // Authenticated users can create a delivery for themselves
      allow create: if request.auth != null &&
                     request.auth.uid == request.resource.data.userId;
      
      // Users can update their own delivery; admins handled by the wildcard below
      allow update: if request.auth != null &&
                     request.auth.uid == resource.data.userId;
      
      // Users can delete their own delivery
      allow delete: if request.auth != null &&
                     request.auth.uid == resource.data.userId;
    }
    
    // ===== ADMIN ACCESS =====
    // Admin users can access everything (using custom claims)
    match /{document=**} {
      allow read, write: if request.auth != null && 
                         request.auth.token.admin == true;
    }
    
    // ===== FALLBACK RULES =====
    // Allow authenticated users basic read access to collections
    match /{collection}/{document} {
      allow read: if request.auth != null;
    }
  }
}