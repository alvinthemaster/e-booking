<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GODTRASCO E-Ticket Confirmation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 400px;
            width: 100%;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #2196F3;
            font-size: 24px;
            font-weight: bold;
        }

        .logo p {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .ticket-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ticket-info h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .info-value {
            color: #333;
            text-align: right;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.confirmed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .auth-section {
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2196F3;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #1976D2;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>GODTRASCO</h1>
            <p>E-Ticket Confirmation</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading ticket information...</p>
        </div>

        <div id="error-container" style="display: none;">
            <div class="error-message" id="error-message"></div>
        </div>

        <div id="ticket-container" style="display: none;">
            <div class="ticket-info">
                <h2>Passenger Information</h2>
                <div class="info-row">
                    <span class="info-label">Passenger:</span>
                    <span class="info-value" id="passenger-name">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Seat Number:</span>
                    <span class="info-value" id="seat-number">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Route:</span>
                    <span class="info-value" id="route-info">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Van:</span>
                    <span class="info-value" id="van-info">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Date:</span>
                    <span class="info-value" id="booking-date">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Booking ID:</span>
                    <span class="info-value" id="booking-id">-</span>
                </div>
            </div>

            <div class="ticket-info" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-left: 4px solid #2196F3;">
                <h2 style="color: #2196F3;">ðŸ’³ Payment Summary</h2>
                <div id="payment-details">
                    <!-- Payment details will be populated here -->
                </div>
            </div>

            <div class="status" id="status-container">
                <span id="status-text">Pending Confirmation</span>
            </div>

            <div id="auth-section" class="auth-section">
                <div class="input-group">
                    <label for="conductor-pin">Conductor PIN:</label>
                    <input type="password" id="conductor-pin" placeholder="Enter conductor PIN" maxlength="6">
                </div>
                <button class="btn" id="confirm-btn" onclick="confirmTicket()">
                    Confirm Boarding
                </button>
            </div>

            <div id="onboard-section" class="auth-section" style="display: none;">
                <div class="input-group">
                    <label for="conductor-pin-onboard">Conductor PIN:</label>
                    <input type="password" id="conductor-pin-onboard" placeholder="Enter conductor PIN" maxlength="6">
                </div>
                <button class="btn" id="onboard-btn" onclick="markAsOnboard()" style="background: #4CAF50;">
                    Mark as Onboard
                </button>
            </div>

            <div id="success-container" style="display: none;">
                <div class="success-message">
                    âœ… Ticket confirmed successfully! Passenger is now onboard.
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration - updated to match Flutter project
        const firebaseConfig = {
            apiKey: "AIzaSyAhHk9O4DDFKKSl4OKD5HrTPOUr2OdQOSk",
            authDomain: "e-ticket-2e8d0.firebaseapp.com",
            projectId: "e-ticket-2e8d0",
            storageBucket: "e-ticket-2e8d0.firebasestorage.app",
            messagingSenderId: "1065852861",
            appId: "1:1065852861:web:7c76ecdb4c61a5f80c7f7e"
        };

        // Initialize Firebase with better error handling
        let db;
        let isFirebaseReady = false;
        
        try {
            console.log('Initializing Firebase...');
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseReady = true;
            console.log('Firebase initialized successfully');
            
            // Test Firebase connection
            db.enableNetwork().then(() => {
                console.log('Firebase Firestore network enabled');
            }).catch((error) => {
                console.warn('Firebase network enable failed:', error);
            });
            
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            isFirebaseReady = false;
        }

        // Conductor PIN (in production, this should be more secure)
        const CONDUCTOR_PIN = '123456';

        let ticketData = null;
        let ticketId = null;

        // Get ticket ID from URL
        function getTicketIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load ticket information
        async function loadTicketInfo() {
            ticketId = getTicketIdFromUrl();
            
            // Check for demo mode
            const urlParams = new URLSearchParams(window.location.search);
            const isDemo = urlParams.get('demo') === 'true';
            const isTest = urlParams.get('test') === 'true';
            
            if (isDemo || isTest) {
                console.log('Demo/Test mode activated');
                // Show demo ticket data
                const demoData = {
                    passengerDetails: { 
                        name: 'Juan Dela Cruz',
                        email: 'juan@example.com',
                        phone: '+63 912 345 6789',
                        regularSeats: ['L1A'],
                        discountedSeats: ['L1B']
                    },
                    userName: 'Juan Dela Cruz',
                    seatIds: ['L1A', 'L1B'],
                    origin: 'General Santos',
                    destination: 'Glan',
                    vanPlateNumber: 'ABC-1234',
                    vanDriverName: 'Pedro Santos',
                    departureTime: { seconds: Date.now() / 1000 },
                    eTicketId: 'ET-DEMO123',
                    bookingStatus: 'confirmed',
                    basePrice: 280.00,
                    discountAmount: 20.00,
                    totalAmount: 295.00
                };
                ticketData = demoData;
                // Compute initial status for demo based on discounts
                const demoHasDiscount = (demoData.discountAmount && demoData.discountAmount > 0) ||
                    (demoData.passengerDetails && demoData.passengerDetails.discountedSeats && demoData.passengerDetails.discountedSeats.length > 0);
                demoData.bookingStatus = demoHasDiscount ? 'pending' : 'confirmed';

                displayTicketInfo(demoData);
                // For demo/test mode, show appropriate UI based on computed status
                if (isDemo || isTest) {
                    if (demoData.bookingStatus === 'confirmed') {
                        document.getElementById('status-text').textContent = 'Demo Mode - Confirmed (Ready for Onboard)';
                        showConfirmedForOnboard();
                    } else {
                        document.getElementById('status-text').textContent = 'Demo Mode - Pending Confirmation';
                    }
                }
                return;
            }
            
            if (!ticketId) {
                showError('No ticket ID provided. Please scan a valid QR code to access this page.');
                // Add demo/test information
                document.getElementById('error-message').innerHTML = `
                    <strong>No ticket ID provided</strong><br><br>
                    
                    <div style="margin: 16px 0;">
                        <strong>Test Options:</strong><br>
                        <a href="${window.location.origin}?demo=true" style="color: #2196F3; text-decoration: none; display: block; margin: 8px 0;">
                            ðŸŽ¯ Demo Mode - Sample ticket data
                        </a>
                        <a href="${window.location.origin}?test=true" style="color: #2196F3; text-decoration: none; display: block; margin: 8px 0;">
                            ðŸ§ª Test Mode - Alternative sample data
                        </a>
                    </div>
                    
                    <div style="margin: 16px 0;">
                        <strong>Real Usage:</strong><br>
                        Use with a real booking ID:<br>
                        <code style="background: #f0f0f0; padding: 4px; border-radius: 4px; font-size: 12px;">
                            ${window.location.origin}?id=YOUR_BOOKING_ID
                        </code><br>
                        Or scan a QR code from the GODTRASCO app.
                    </div>
                `;
                return;
            }

            try {
                console.log('Loading ticket with ID:', ticketId);
                document.getElementById('loading').style.display = 'block';
                
                // Check if Firebase is initialized and ready
                if (!isFirebaseReady || !db) {
                    throw new Error('Firebase not properly initialized');
                }
                
                console.log('Firebase is ready, attempting to fetch booking...');
                
                // Get booking from Firestore (using booking ID)
                console.log('Fetching booking from Firestore collection: bookings, document:', ticketId);
                const bookingDoc = await db.collection('bookings').doc(ticketId).get();
                
                console.log('Booking document exists:', bookingDoc.exists);
                console.log('Booking document data:', bookingDoc.data());
                
                if (!bookingDoc.exists) {
                    showError('Booking not found. This QR code may be invalid or expired.');
                    return;
                }

                ticketData = bookingDoc.data();
                console.log('Loaded ticket data:', ticketData);
                
                // Check booking status and show appropriate UI
                if (ticketData.bookingStatus === 'onboard' || ticketData.bookingStatus === 'completed') {
                    console.log('Booking already processed with status:', ticketData.bookingStatus);
                    showAlreadyProcessed(ticketData.bookingStatus);
                    return;
                } else if (ticketData.bookingStatus === 'confirmed') {
                    console.log('Booking confirmed, showing onboard option');
                    showConfirmedForOnboard();
                    return;
                } else {
                    // For any other status (like pending from old bookings), show confirm option
                    console.log('Booking pending or unknown status, showing confirm option');
                    // Ensure the confirm UI is visible and onboard UI is hidden for pending bookings
                    document.getElementById('auth-section').style.display = 'block';
                    document.getElementById('onboard-section').style.display = 'none';
                    document.getElementById('status-container').className = 'status pending';
                    document.getElementById('status-text').textContent = 'â³ Pending Confirmation';
                }

                // Display ticket information
                displayTicketInfo(ticketData);
                console.log('Ticket information displayed successfully');
                
            } catch (error) {
                console.error('Error loading ticket:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                let errorMessage = 'Error loading ticket information: ' + error.message;
                
                // Provide specific error guidance
                if (error.message.includes('permission') || error.message.includes('insufficient')) {
                    errorMessage += '\n\nThis might be a permissions issue. The Firestore rules have been updated and should allow access.';
                } else if (error.message.includes('not found')) {
                    errorMessage += '\n\nThe booking ID might be invalid or the booking does not exist.';
                } else if (error.message.includes('network') || error.message.includes('offline')) {
                    errorMessage += '\n\nPlease check your internet connection and try again.';
                }
                
                showError(errorMessage);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Display ticket information
        function displayTicketInfo(data) {
            document.getElementById('passenger-name').textContent = data.passengerDetails?.name || data.userName || 'N/A';
            document.getElementById('seat-number').textContent = data.seatIds?.join(', ') || 'N/A';
            document.getElementById('route-info').textContent = `${data.origin || 'N/A'} â†’ ${data.destination || 'N/A'}`;
            document.getElementById('van-info').textContent = `${data.vanPlateNumber || 'N/A'} (${data.vanDriverName || 'N/A'})`;
            document.getElementById('booking-date').textContent = data.departureTime ? new Date(data.departureTime.seconds * 1000).toLocaleDateString() : 'N/A';
            document.getElementById('booking-id').textContent = data.eTicketId || ticketId;
            
            // Display payment summary
            displayPaymentSummary(data);
            
            document.getElementById('ticket-container').style.display = 'block';
        }

        // Display payment summary with seat breakdown
        function displayPaymentSummary(data) {
            const paymentContainer = document.getElementById('payment-details');
            const regularSeats = data.passengerDetails?.regularSeats || [];
            const discountedSeats = data.passengerDetails?.discountedSeats || [];
            const totalAmount = data.totalAmount || 0;
            const discountAmount = data.discountAmount || 0;
            const basePrice = data.basePrice || 0;
            
            let html = '';
            
            // Regular fare seats
            if (regularSeats.length > 0) {
                html += `
                    <div class="info-row">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #555;">Regular Fare:</div>
                            <div style="font-size: 12px; color: #888; margin-top: 2px;">${regularSeats.join(', ')}</div>
                        </div>
                        <span class="info-value">â‚±${(regularSeats.length * 150).toFixed(2)}</span>
                    </div>
                `;
            }
            
            // Discounted fare seats
            if (discountedSeats.length > 0) {
                html += `
                    <div class="info-row">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #555;">Discounted Fare:</div>
                            <div style="font-size: 12px; color: #888; margin-top: 2px;">${discountedSeats.join(', ')} (PWD/Senior/Student)</div>
                        </div>
                        <span class="info-value">â‚±${(discountedSeats.length * 130).toFixed(2)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Discount Applied:</span>
                        <span class="info-value" style="color: #4CAF50; font-weight: 600;">-â‚±${(discountedSeats.length * 20).toFixed(2)}</span>
                    </div>
                `;
            }
            
            // Fallback if no seat breakdown available
            if (regularSeats.length === 0 && discountedSeats.length === 0) {
                html += `
                    <div class="info-row">
                        <span class="info-label">Fare Subtotal:</span>
                        <span class="info-value">â‚±${basePrice.toFixed(2)}</span>
                    </div>
                `;
                
                if (discountAmount > 0) {
                    html += `
                        <div class="info-row">
                            <span class="info-label">Discount Applied:</span>
                            <span class="info-value" style="color: #4CAF50; font-weight: 600;">-â‚±${discountAmount.toFixed(2)}</span>
                        </div>
                    `;
                }
            }
            
            // Booking fee
            html += `
                <div class="info-row">
                    <span class="info-label">Booking Fee:</span>
                    <span class="info-value">â‚±15.00</span>
                </div>
            `;
            
            // Total amount with separator
            html += `
                <div class="info-row" style="border-top: 2px solid #2196F3; margin-top: 8px; padding-top: 8px;">
                    <span class="info-label" style="font-size: 16px; font-weight: bold; color: #2196F3;">Total Amount:</span>
                    <span class="info-value" style="font-size: 18px; font-weight: bold; color: #2196F3;">â‚±${totalAmount.toFixed(2)}</span>
                </div>
            `;
            
            paymentContainer.innerHTML = html;
        }

        // Show error message
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Show already processed status (onboard or completed)
        function showAlreadyProcessed(status) {
            displayTicketInfo(ticketData);
            document.getElementById('status-container').className = 'status confirmed';
            const statusText = status === 'completed' ? 'âœ… Trip Completed' : 'âœ… Already Onboard';
            document.getElementById('status-text').textContent = statusText;
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('onboard-section').style.display = 'none';
        }

        // Show confirmed status with onboard option
        function showConfirmedForOnboard() {
            displayTicketInfo(ticketData);
            document.getElementById('status-container').className = 'status confirmed';
            document.getElementById('status-text').textContent = 'âœ… Confirmed - Ready for Boarding';
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('onboard-section').style.display = 'block';
        }

        // Confirm ticket
        async function confirmTicket() {
            const enteredPin = document.getElementById('conductor-pin').value;
            
            if (!enteredPin) {
                alert('Please enter the conductor PIN');
                return;
            }

            if (enteredPin !== CONDUCTOR_PIN) {
                alert('Invalid PIN. Please contact your supervisor.');
                return;
            }

            try {
                const confirmBtn = document.getElementById('confirm-btn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Confirming...';

                // Check if this is demo/test mode
                const urlParams = new URLSearchParams(window.location.search);
                const isDemo = urlParams.get('demo') === 'true';
                const isTest = urlParams.get('test') === 'true';

                if (isDemo || isTest) {
                    // Simulate confirmation in demo mode
                    console.log('Demo/Test mode confirmation');
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate delay
                } else {
                    // Real Firebase update - Set to 'confirmed' to lock the seat
                    console.log('Updating booking status for ID:', ticketId);
                    await db.collection('bookings').doc(ticketId).update({
                        bookingStatus: 'confirmed', // Changed from 'onboard' to 'confirmed' to lock seat
                        confirmedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        confirmedBy: 'conductor'
                    });
                }

                // Update local state and show onboard option so conductor can immediately mark as onboard
                ticketData.bookingStatus = 'confirmed';
                document.getElementById('success-container').style.display = 'block';
                document.getElementById('success-container').innerHTML = '<div class="success-message">âœ… Ticket confirmed successfully! Ready for boarding.</div>';
                // Show the onboard option
                showConfirmedForOnboard();

            } catch (error) {
                console.error('Error confirming ticket:', error);
                alert('Error confirming ticket: ' + error.message + '. Please try again.');
                
                const confirmBtn = document.getElementById('confirm-btn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Boarding';
            }
        }

        // Mark ticket as onboard
        async function markAsOnboard() {
            const enteredPin = document.getElementById('conductor-pin-onboard').value;
            
            if (!enteredPin) {
                alert('Please enter the conductor PIN');
                return;
            }

            if (enteredPin !== CONDUCTOR_PIN) {
                alert('Invalid PIN. Please contact your supervisor.');
                return;
            }

            try {
                // Ensure only confirmed tickets can be marked as onboard
                if (!ticketData || ticketData.bookingStatus !== 'confirmed') {
                    alert('Only tickets with status "confirmed" can be marked as onboard. Current status: ' + (ticketData ? ticketData.bookingStatus : 'unknown'));
                    return;
                }

                const onboardBtn = document.getElementById('onboard-btn');
                onboardBtn.disabled = true;
                onboardBtn.textContent = 'Marking...';

                // Check if this is demo/test mode
                const urlParams = new URLSearchParams(window.location.search);
                const isDemo = urlParams.get('demo') === 'true';
                const isTest = urlParams.get('test') === 'true';

                if (isDemo || isTest) {
                    // Simulate onboard marking in demo mode
                    console.log('Demo/Test mode onboard marking');
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate delay
                } else {
                    // Real Firebase update - Set to 'onboard'
                    console.log('Updating booking status to onboard for ID:', ticketId);
                    await db.collection('bookings').doc(ticketId).update({
                        bookingStatus: 'onboard',
                        onboardAt: firebase.firestore.FieldValue.serverTimestamp(),
                        onboardBy: 'conductor'
                    });
                }

                // Show success
                document.getElementById('onboard-section').style.display = 'none';
                document.getElementById('success-container').style.display = 'block';
                document.getElementById('status-container').className = 'status confirmed';
                document.getElementById('status-text').textContent = 'âœ… Onboard';
                document.getElementById('success-container').innerHTML = '<div class="success-message">âœ… Passenger marked as onboard successfully!</div>';

            } catch (error) {
                console.error('Error marking as onboard:', error);
                alert('Error marking as onboard: ' + error.message + '. Please try again.');
                
                const onboardBtn = document.getElementById('onboard-btn');
                onboardBtn.disabled = false;
                onboardBtn.textContent = 'Mark as Onboard';
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('Page loaded, starting initialization...');
            
            // Add debug info
            const urlParams = new URLSearchParams(window.location.search);
            const ticketId = urlParams.get('id');
            const isDemo = urlParams.get('demo') === 'true';
            
            console.log('URL params:', { ticketId, isDemo });
            console.log('Firebase available:', typeof firebase !== 'undefined');
            
            // Test Firebase connection if not in demo mode
            if (!isDemo && !ticketId) {
                console.log('Testing Firebase connection...');
                if (isFirebaseReady && db) {
                    // Test basic Firestore read access
                    db.collection('routes').limit(1).get()
                        .then((snapshot) => {
                            console.log('Firebase test successful, found', snapshot.size, 'route documents');
                        })
                        .catch((error) => {
                            console.error('Firebase test failed:', error);
                        });
                }
            }
            
            // Wait a bit for Firebase to fully load
            setTimeout(loadTicketInfo, 100);
        });

        // Allow Enter key to confirm
        document.getElementById('conductor-pin').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmTicket();
            }
        });

        // Allow Enter key to mark as onboard
        document.getElementById('conductor-pin-onboard').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                markAsOnboard();
            }
        });
    </script>
</body>
</html>
