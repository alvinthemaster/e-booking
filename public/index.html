<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GODTRASCO – Ticket Confirmation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 24px 16px 40px;
        }

        .page-wrap {
            width: 100%;
            max-width: 440px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* LOGO */
        .logo { text-align: center; padding: 8px 0 4px; }
        .logo h1 { color: #fff; font-size: 22px; font-weight: 800; letter-spacing: 1px; }
        .logo p  { color: rgba(255,255,255,0.75); font-size: 13px; margin-top: 3px; }

        /* LOADING */
        .loading { display: none; text-align: center; padding: 32px 0; }
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 36px; height: 36px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        .loading p { color: #fff; font-size: 14px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ERROR */
        .error-box {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            border-left: 5px solid #F44336;
            display: none;
        }
        .error-box h3 { color: #F44336; margin-bottom: 10px; }
        .error-box p  { color: #555; font-size: 14px; line-height: 1.6; }
        .demo-links { margin-top: 16px; }
        .demo-link {
            display: block;
            padding: 10px 14px;
            background: #f5f5f5;
            border-radius: 8px;
            color: #2196F3;
            text-decoration: none;
            font-size: 13px;
            margin-bottom: 8px;
        }

        /* TICKET CARD */
        .ticket-card {
            background: #fff;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            display: none;
        }

        /* Card header */
        .card-header { padding: 20px 22px 18px; color: #fff; }
        .card-header.blue   { background: linear-gradient(135deg, #2196F3, #1565C0); }
        .card-header.orange { background: linear-gradient(135deg, #FF9800, #E65100); }

        .card-header-row { display: flex; align-items: center; gap: 14px; }
        .card-header-icon {
            width: 48px; height: 48px;
            background: rgba(255,255,255,0.18);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px; flex-shrink: 0;
        }
        .card-header-title { font-size: 18px; font-weight: 800; }
        .card-header-sub   { font-size: 12px; opacity: 0.8; margin-top: 2px; }
        .card-header-ref   {
            margin-top: 12px;
            font-family: monospace;
            font-size: 13px;
            opacity: 0.9;
            font-weight: 600;
        }

        /* Card body */
        .card-body { padding: 20px 22px; }
        .section { margin-bottom: 18px; }
        .section:last-child { margin-bottom: 0; }

        /* Route box */
        .route-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .route-end { flex: 1; }
        .route-end.right { text-align: right; }
        .route-label { font-size: 10px; color: #999; font-weight: 600; text-transform: uppercase; margin-bottom: 3px; }
        .route-city  { font-size: 15px; font-weight: 700; color: #222; }
        .route-arrow       { font-size: 18px; color: #2196F3; flex-shrink: 0; }
        .route-arrow.orange { color: #FF9800; }

        /* Info rows */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 9px 0;
            border-bottom: 1px solid #f0f0f0;
            gap: 12px;
        }
        .info-row:last-child { border-bottom: none; padding-bottom: 0; }
        .info-label { font-size: 13px; font-weight: 600; color: #666; white-space: nowrap; }
        .info-value { font-size: 13px; color: #222; text-align: right; word-break: break-word; }

        /* Two-column sender/receiver */
        .two-col { display: flex; gap: 10px; }
        .two-col-box {
            flex: 1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 11px 12px;
        }
        .two-col-label   { font-size: 10px; color: #999; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; }
        .two-col-name    { font-size: 14px; font-weight: 700; color: #222; margin-bottom: 2px; }
        .two-col-contact { font-size: 12px; color: #666; }

        /* Payment box */
        .payment-box {
            background: #f0f7ff;
            border-radius: 12px;
            padding: 14px 16px;
        }
        .payment-box.orange-bg { background: #fff8f0; }
        .payment-title {
            font-size: 13px; font-weight: 700;
            color: #2196F3; margin-bottom: 10px;
        }
        .payment-title.orange { color: #FF9800; }
        .pay-row {
            display: flex; justify-content: space-between;
            font-size: 13px; margin-bottom: 7px; color: #444;
        }
        .pay-row:last-child { margin-bottom: 0; }
        .pay-divider { border: none; border-top: 1px dashed #ccc; margin: 10px 0; }
        .pay-total-row {
            display: flex; justify-content: space-between;
            font-size: 16px; font-weight: 800; color: #2196F3;
        }
        .pay-total-row.orange { color: #FF9800; }
        .pay-method-row {
            display: flex; justify-content: space-between;
            align-items: center; margin-top: 10px;
            padding-top: 10px; border-top: 1px solid #e0e0e0;
        }
        .pay-method-label { font-size: 11px; color: #999; }
        .pay-method-value { font-size: 13px; font-weight: 600; color: #333; }
        .pay-status-badge {
            display: inline-block;
            padding: 3px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
        }
        .pay-status-badge.paid    { background: #e8f5e9; color: #2E7D32; border: 1px solid #a5d6a7; }
        .pay-status-badge.unpaid  { background: #fff3e0; color: #E65100; border: 1px solid #ffcc80; }

        /* Dashed divider */
        .dashed-divider { border: none; border-top: 2px dashed #e0e0e0; margin: 18px 0; }

        /* Status strip */
        .status-strip {
            border-radius: 10px; padding: 12px 16px;
            font-size: 14px; font-weight: 700;
            text-align: center; margin-bottom: 18px;
        }
        .status-strip.pending { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .status-strip.success { background: #e8f5e9; color: #1B5E20; border: 1px solid #81C784; }
        .status-strip.transit { background: #e3f2fd; color: #0D47A1; border: 1px solid #90CAF9; }
        .status-strip.danger  { background: #fce4ec; color: #880E4F; border: 1px solid #F48FB1; }

        /* PIN + action */
        .pin-section { margin-top: 6px; }
        .pin-label {
            font-size: 13px; font-weight: 600; color: #555;
            margin-bottom: 6px; display: block;
        }
        .pin-input {
            width: 100%; padding: 13px 14px;
            border: 2px solid #e0e0e0; border-radius: 10px;
            font-size: 18px; letter-spacing: 4px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        .pin-input:focus       { outline: none; border-color: #2196F3; }
        .pin-input.orange:focus { border-color: #FF9800; }

        .action-btn {
            width: 100%; padding: 15px;
            border: none; border-radius: 10px;
            font-size: 15px; font-weight: 700;
            cursor: pointer; transition: opacity 0.2s;
            color: #fff; letter-spacing: 0.3px;
        }
        .action-btn:hover    { opacity: 0.88; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.blue   { background: #2196F3; }
        .action-btn.green  { background: #4CAF50; }
        .action-btn.orange { background: #FF9800; }

        .success-msg {
            background: #e8f5e9; color: #1B5E20;
            border: 1px solid #81C784;
            border-radius: 10px; padding: 13px;
            font-size: 14px; font-weight: 600;
            text-align: center; margin-top: 14px;
        }

        .section-label {
            font-size: 11px; font-weight: 700; color: #999;
            text-transform: uppercase; letter-spacing: 0.8px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="page-wrap">

    <!-- LOGO -->
    <div class="logo">
        <h1>GODTRASCO</h1>
        <p id="page-subtitle">E-Ticket Confirmation</p>
    </div>

    <!-- LOADING -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading ticket information…</p>
    </div>

    <!-- ERROR -->
    <div id="error-container" class="error-box">
        <h3>⚠️ Error</h3>
        <p id="error-message">An error occurred.</p>
        <div class="demo-links" id="demo-links" style="display:none;">
            <div style="font-size:13px;font-weight:600;color:#555;margin-bottom:8px;">Try a demo:</div>
            <a class="demo-link" href="?demo=true">🎫 Demo – Normal Booking</a>
            <a class="demo-link" href="?demo=delivery">📦 Demo – Document Delivery</a>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════
         NORMAL BOOKING
    ═══════════════════════════════════════════════════════ -->
    <div id="ticket-container" class="ticket-card">

        <div class="card-header blue">
            <div class="card-header-row">
                <div class="card-header-icon">🎫</div>
                <div>
                    <div class="card-header-title">GODTRASCO</div>
                    <div class="card-header-sub">Passenger E-Ticket</div>
                </div>
            </div>
            <div class="card-header-ref" id="booking-ref">Ref: —</div>
        </div>

        <div class="card-body">

            <!-- Passenger -->
            <div class="section">
                <div class="section-label">Passenger</div>
                <div class="info-row">
                    <span class="info-label">Name</span>
                    <span class="info-value" id="passenger-name">—</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Seat(s)</span>
                    <span class="info-value" id="seat-number">—</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Departure</span>
                    <span class="info-value" id="booking-date">—</span>
                </div>
            </div>

            <!-- Route -->
            <div class="section">
                <div class="section-label">Route</div>
                <div class="route-box">
                    <div class="route-end">
                        <div class="route-label">From</div>
                        <div class="route-city" id="route-origin">—</div>
                    </div>
                    <div class="route-arrow">→</div>
                    <div class="route-end right">
                        <div class="route-label">To</div>
                        <div class="route-city" id="route-destination">—</div>
                    </div>
                </div>
            </div>

            <!-- Van -->
            <div class="section">
                <div class="info-row" style="border-bottom:none;padding:0;">
                    <span class="info-label">🚐 Van / Driver</span>
                    <span class="info-value" id="van-info">—</span>
                </div>
            </div>

            <hr class="dashed-divider">

            <!-- Payment -->
            <div class="section">
                <div class="payment-box">
                    <div class="payment-title">💳 Payment Summary</div>
                    <div id="payment-details"></div>
                </div>
            </div>

            <hr class="dashed-divider">

            <!-- Status -->
            <div class="status-strip pending" id="status-container">
                <span id="status-text">⏳ Pending Confirmation</span>
            </div>

            <!-- Confirm boarding -->
            <div id="auth-section" class="pin-section">
                <label class="pin-label">Conductor PIN</label>
                <input type="password" class="pin-input" id="conductor-pin"
                       placeholder="● ● ● ● ● ●" maxlength="6">
                <button class="action-btn blue" id="confirm-btn" onclick="confirmTicket()">
                    Confirm Boarding
                </button>
            </div>

            <!-- Mark as onboard -->
            <div id="onboard-section" class="pin-section" style="display:none;">
                <label class="pin-label">Conductor PIN</label>
                <input type="password" class="pin-input" id="conductor-pin-onboard"
                       placeholder="● ● ● ● ● ●" maxlength="6">
                <button class="action-btn green" id="onboard-btn" onclick="markAsOnboard()">
                    ✅ Mark as Onboard
                </button>
            </div>

            <div id="success-container" style="display:none;"></div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════════════
         DOCUMENT DELIVERY
    ═══════════════════════════════════════════════════════ -->
    <div id="delivery-container" class="ticket-card">

        <div class="card-header orange">
            <div class="card-header-row">
                <div class="card-header-icon">📦</div>
                <div>
                    <div class="card-header-title">GODTRASCO</div>
                    <div class="card-header-sub">Document Delivery</div>
                </div>
            </div>
            <div class="card-header-ref" id="d-ref">Ref: —</div>
        </div>

        <div class="card-body">

            <!-- Route -->
            <div class="section">
                <div class="section-label">Route</div>
                <div class="route-box">
                    <div class="route-end">
                        <div class="route-label">From</div>
                        <div class="route-city" id="d-origin">—</div>
                    </div>
                    <div class="route-arrow orange">→</div>
                    <div class="route-end right">
                        <div class="route-label">To</div>
                        <div class="route-city" id="d-destination">—</div>
                    </div>
                </div>
            </div>

            <!-- Sender / Receiver -->
            <div class="section">
                <div class="section-label">Sender → Receiver</div>
                <div class="two-col">
                    <div class="two-col-box">
                        <div class="two-col-label">📤 Sender</div>
                        <div class="two-col-name"    id="d-sender-name">—</div>
                        <div class="two-col-contact" id="d-sender-contact">—</div>
                    </div>
                    <div class="two-col-box">
                        <div class="two-col-label">📥 Receiver</div>
                        <div class="two-col-name"    id="d-receiver-name">—</div>
                        <div class="two-col-contact" id="d-receiver-contact">—</div>
                    </div>
                </div>
            </div>

            <!-- Document details -->
            <div class="section">
                <div class="section-label">Document Details</div>
                <div class="info-row">
                    <span class="info-label">📄 Type</span>
                    <span class="info-value" id="d-doc-type">—</span>
                </div>
                <div class="info-row" id="d-note-row" style="display:none;">
                    <span class="info-label">📝 Note</span>
                    <span class="info-value" id="d-note">—</span>
                </div>
                <div class="info-row">
                    <span class="info-label">🗓 Date</span>
                    <span class="info-value" id="d-date">—</span>
                </div>
                <div class="info-row">
                    <span class="info-label">🚐 Van / Driver</span>
                    <span class="info-value" id="d-van">—</span>
                </div>
            </div>

            <hr class="dashed-divider">

            <!-- Fee summary -->
            <div class="section">
                <div class="payment-box orange-bg">
                    <div class="payment-title orange">💳 Fee Summary</div>
                    <div class="pay-row">
                        <span>Delivery Fee</span>
                        <span>₱100.00</span>
                    </div>
                    <div class="pay-row">
                        <span>Booking Fee</span>
                        <span>₱15.00</span>
                    </div>
                    <hr class="pay-divider">
                    <div class="pay-total-row orange">
                        <span>Total</span>
                        <span id="d-total">₱115.00</span>
                    </div>
                    <div class="pay-method-row">
                        <div>
                            <div class="pay-method-label">Payment Method</div>
                            <div class="pay-method-value" id="d-payment-method">—</div>
                        </div>
                        <span class="pay-status-badge unpaid" id="d-payment-status-badge">⏳ Unpaid</span>
                    </div>
                </div>
            </div>

            <hr class="dashed-divider">

            <!-- Status -->
            <div class="status-strip pending" id="d-status-container">
                <span id="d-status-text">Loading…</span>
            </div>

            <!-- Pickup PIN -->
            <div id="d-pickup-section" class="pin-section" style="display:none;">
                <label class="pin-label">Conductor PIN</label>
                <input type="password" class="pin-input orange" id="d-conductor-pin-pickup"
                       placeholder="● ● ● ● ● ●" maxlength="6">
                <button class="action-btn orange" id="d-pickup-btn" onclick="confirmDeliveryPickup()">
                    📦 Confirm Pickup (Mark In-Transit)
                </button>
            </div>

            <!-- Delivered PIN -->
            <div id="d-received-section" class="pin-section" style="display:none;">
                <label class="pin-label">Conductor PIN</label>
                <input type="password" class="pin-input orange" id="d-conductor-pin-received"
                       placeholder="● ● ● ● ● ●" maxlength="6">
                <button class="action-btn green" id="d-received-btn" onclick="confirmDeliveryReceived()">
                    ✅ Confirm Delivered to Receiver
                </button>
            </div>

            <div id="d-success-container" style="display:none;">
                <div class="success-msg" id="d-success-text"></div>
            </div>
        </div>
    </div>

</div><!-- /.page-wrap -->

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAhHk9O4DDFKKSl4OKD5HrTPOUr2OdQOSk",
        authDomain: "e-ticket-2e8d0.firebaseapp.com",
        projectId: "e-ticket-2e8d0",
        storageBucket: "e-ticket-2e8d0.firebasestorage.app",
        messagingSenderId: "1065852861",
        appId: "1:1065852861:web:7c76ecdb4c61a5f80c7f7e"
    };

    let db, isFirebaseReady = false;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        isFirebaseReady = true;
        db.enableNetwork().catch(() => {});
    } catch (e) {
        console.error('Firebase init failed:', e);
    }

    const CONDUCTOR_PIN = '123456';
    let ticketData = null, ticketId = null;
    let deliveryData = null, deliveryDocId = null;

    // Document type label map (matches Dart DocumentType enum toString)
    // Keys match Dart DocumentType enum .name values stored in Firestore
    const DOC_TYPE_LABELS = {
        envelope:     'Envelope',
        legalDocument:'Legal Document',
        id:           'ID / Government Document',
        parcel:       'Parcel / Package',
        other:        'Other',
        // legacy fallbacks for older stored values
        contract:     'Contract',
        certificate:  'Certificate',
        idDocument:   'ID Document',
        package:      'Package',
        id_document:  'ID Document',
    };

    function getDocTypeLabel(raw) {
        if (!raw) return '—';
        return DOC_TYPE_LABELS[raw] || raw.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ')
               .replace(/\b\w/g, c => c.toUpperCase()).trim();
    }

    function getTicketIdFromUrl() {
        return new URLSearchParams(window.location.search).get('id');
    }

    function showError(msg) {
        document.getElementById('loading').style.display = 'none';
        const box = document.getElementById('error-container');
        box.style.display = 'block';
        document.getElementById('error-message').innerHTML = msg;
    }

    // ── ENTRY POINT ────────────────────────────────────────────────────
    async function loadTicketInfo() {
        ticketId = getTicketIdFromUrl();
        const urlParams = new URLSearchParams(window.location.search);
        const isDemo = urlParams.get('demo');

        if (isDemo === 'true' || isDemo === 'booking') { loadDemoBooking(); return; }
        if (isDemo === 'delivery')                      { loadDemoDelivery(); return; }

        if (!ticketId) {
            showError('<strong>No ticket ID provided.</strong><br>Scan a valid QR code from the GODTRASCO app.');
            document.getElementById('demo-links').style.display = 'block';
            return;
        }

        if (ticketId.startsWith('DELIVERY:')) {
            await loadDeliveryInfo(ticketId.substring('DELIVERY:'.length));
            return;
        }

        // Normal booking
        document.getElementById('loading').style.display = 'block';
        try {
            if (!isFirebaseReady) throw new Error('Firebase not initialized');
            const snap = await db.collection('bookings').doc(ticketId).get();
            if (!snap.exists) {
                // Fallback: maybe the DELIVERY: prefix was stripped — try document_deliveries
                const deliveryFallback = await db.collection('document_deliveries').doc(ticketId).get();
                if (deliveryFallback.exists) {
                    deliveryDocId  = ticketId;
                    deliveryData   = deliveryFallback.data();
                    renderDeliveryTicket(deliveryData);
                    return;
                }
                showError('Booking not found. This QR code may be invalid or expired.');
                return;
            }
            ticketData = snap.data();
            renderBookingTicket(ticketData);
        } catch (err) {
            showError('Error loading ticket: ' + err.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // ── NORMAL BOOKING RENDER ──────────────────────────────────────────
    function renderBookingTicket(data) {
        document.getElementById('page-subtitle').textContent = 'Normal Booking Confirmation';
        document.getElementById('booking-ref').textContent =
            'Ref: ' + (data.eTicketId || (ticketId ? ticketId.substring(0,8).toUpperCase() : '—'));

        $set('passenger-name', data.passengerDetails?.name || data.userName || '—');
        $set('seat-number',    (data.seatIds || []).join(', ') || '—');
        $set('booking-date',   data.departureTime
            ? new Date(data.departureTime.seconds * 1000)
                .toLocaleString('en-PH', { dateStyle: 'medium', timeStyle: 'short' })
            : '—');
        $set('route-origin',      data.origin      || '—');
        $set('route-destination', data.destination || '—');
        $set('van-info',
            [data.vanPlateNumber, data.vanDriverName].filter(Boolean).join(' · ') || '—');

        renderPaymentSummary(data);
        document.getElementById('ticket-container').style.display = 'block';

        const status = data.bookingStatus || '';
        if (status === 'onboard' || status === 'completed') {
            setBookingStatus('success',
                status === 'completed' ? '✅ Trip Completed' : '✅ Already Onboard');
            hide('auth-section'); hide('onboard-section');
        } else if (status === 'confirmed') {
            showConfirmedForOnboard();
        } else {
            setBookingStatus('pending', '⏳ Pending Confirmation');
            show('auth-section'); hide('onboard-section');
        }
    }

    function renderPaymentSummary(data) {
        const cont = document.getElementById('payment-details');
        const reg  = data.passengerDetails?.regularSeats    || [];
        const disc = data.passengerDetails?.discountedSeats || [];
        const totalAmount    = data.totalAmount    || 0;
        const discountAmount = data.discountAmount || 0;
        const basePrice      = data.basePrice      || 0;

        let html = '';
        if (reg.length > 0) {
            html += payRow(
                'Regular Fare <small style="color:#999">(' + reg.join(', ') + ')</small>',
                '₱' + (reg.length * 150).toFixed(2));
        }
        if (disc.length > 0) {
            html += payRow(
                'Discounted Fare <small style="color:#999">(' + disc.join(', ') + ')</small>',
                '₱' + (disc.length * 130).toFixed(2));
            html += payRow(
                '<span style="color:#4CAF50">Discount Applied</span>',
                '<span style="color:#4CAF50">-₱' + (disc.length * 20).toFixed(2) + '</span>');
        }
        if (reg.length === 0 && disc.length === 0) {
            html += payRow('Fare Subtotal', '₱' + basePrice.toFixed(2));
            if (discountAmount > 0)
                html += payRow(
                    '<span style="color:#4CAF50">Discount</span>',
                    '<span style="color:#4CAF50">-₱' + discountAmount.toFixed(2) + '</span>');
        }
        html += payRow('Booking Fee', '₱15.00');
        html += '<hr class="pay-divider">' +
                '<div class="pay-total-row"><span>Total</span><span>₱' + totalAmount.toFixed(2) + '</span></div>';

        if (data.paymentMethod) {
            const paid = data.paymentStatus === 'paid';
            html += '<div class="pay-method-row">' +
                    '<div><div class="pay-method-label">Payment Method</div>' +
                    '<div class="pay-method-value">' + data.paymentMethod + '</div></div>' +
                    '<span class="pay-status-badge ' + (paid ? 'paid' : 'unpaid') + '">' +
                    (paid ? '✅ Paid' : '⏳ Unpaid') + '</span></div>';
        }
        cont.innerHTML = html;
    }

    function payRow(label, value) {
        return '<div class="pay-row"><span>' + label + '</span><span>' + value + '</span></div>';
    }

    function setBookingStatus(cls, txt) {
        const el = document.getElementById('status-container');
        el.className = 'status-strip ' + cls;
        document.getElementById('status-text').textContent = txt;
    }

    function showConfirmedForOnboard() {
        setBookingStatus('success', '✅ Confirmed – Ready for Boarding');
        hide('auth-section');
        show('onboard-section');
    }

    // ── NORMAL BOOKING ACTIONS ─────────────────────────────────────────
    async function confirmTicket() {
        const pin = document.getElementById('conductor-pin').value;
        if (!pin)              { alert('Please enter the conductor PIN'); return; }
        if (pin !== CONDUCTOR_PIN) { alert('Invalid PIN.'); return; }

        const btn = document.getElementById('confirm-btn');
        btn.disabled = true; btn.textContent = 'Confirming…';
        try {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('demo')) {
                await delay(600);
            } else {
                await db.collection('bookings').doc(ticketId).update({
                    bookingStatus: 'confirmed',
                    confirmedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    confirmedBy: 'conductor'
                });
            }
            ticketData.bookingStatus = 'confirmed';
            document.getElementById('success-container').innerHTML =
                '<div class="success-msg">✅ Ticket confirmed! Ready for boarding.</div>';
            show('success-container');
            showConfirmedForOnboard();
        } catch (err) {
            alert('Error: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Confirm Boarding';
        }
    }

    async function markAsOnboard() {
        const pin = document.getElementById('conductor-pin-onboard').value;
        if (!pin)              { alert('Please enter the conductor PIN'); return; }
        if (pin !== CONDUCTOR_PIN) { alert('Invalid PIN.'); return; }
        if (!ticketData || ticketData.bookingStatus !== 'confirmed') {
            alert('Ticket must be confirmed first.'); return;
        }

        const btn = document.getElementById('onboard-btn');
        btn.disabled = true; btn.textContent = 'Marking…';
        try {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('demo')) {
                await delay(600);
            } else {
                await db.collection('bookings').doc(ticketId).update({
                    bookingStatus: 'onboard',
                    onboardAt: firebase.firestore.FieldValue.serverTimestamp(),
                    onboardBy: 'conductor'
                });
            }
            ticketData.bookingStatus = 'onboard';
            hide('onboard-section');
            setBookingStatus('success', '✅ Onboard');
            document.getElementById('success-container').innerHTML =
                '<div class="success-msg">✅ Passenger marked as onboard!</div>';
            show('success-container');
        } catch (err) {
            alert('Error: ' + err.message);
            btn.disabled = false;
            btn.textContent = '✅ Mark as Onboard';
        }
    }

    // ── DELIVERY RENDER ────────────────────────────────────────────────
    async function loadDeliveryInfo(id) {
        deliveryDocId = id;
        document.getElementById('loading').style.display = 'block';
        try {
            if (!isFirebaseReady) throw new Error('Firebase not initialized');
            const snap = await db.collection('document_deliveries').doc(id).get();
            if (!snap.exists) { showError('Delivery record not found.'); return; }
            deliveryData = snap.data();
            renderDeliveryTicket(deliveryData);
        } catch (err) {
            showError('Error loading delivery: ' + err.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderDeliveryTicket(data) {
        document.getElementById('page-subtitle').textContent = 'Document Delivery Confirmation';
        document.getElementById('d-ref').textContent =
            'Ref: ' + (deliveryDocId ? deliveryDocId.substring(0, 8).toUpperCase() : '—');

        $set('d-origin',          data.origin      || '—');
        $set('d-destination',     data.destination || '—');
        $set('d-sender-name',     data.senderName    || '—');
        $set('d-sender-contact',  data.senderContact || '—');
        $set('d-receiver-name',   data.receiverName    || '—');
        $set('d-receiver-contact',data.receiverContact || '—');
        $set('d-doc-type',  getDocTypeLabel(data.documentType));

        if (data.documentTypeNote && data.documentTypeNote.trim()) {
            $set('d-note', data.documentTypeNote);
            document.getElementById('d-note-row').style.display = 'flex';
        }

        $set('d-date', data.createdAt
            ? new Date(data.createdAt.seconds * 1000)
                .toLocaleString('en-PH', { dateStyle: 'medium', timeStyle: 'short' })
            : '—');
        $set('d-van',
            [data.vanPlateNumber, data.vanDriverName].filter(Boolean).join(' · ') || '—');
        // Show stored amount only when it's the correct fee (≥100); old docs stored 50 as default
        const displayTotal = (data.paymentAmount && data.paymentAmount >= 100) ? data.paymentAmount : 115;
        $set('d-total', '₱' + displayTotal.toFixed(2));
        $set('d-payment-method', data.paymentMethod || '—');

        const paid = data.paymentStatus === 'paid';
        const badge = document.getElementById('d-payment-status-badge');
        badge.textContent = paid ? '✅ Paid' : '⏳ Unpaid';
        badge.className   = 'pay-status-badge ' + (paid ? 'paid' : 'unpaid');

        document.getElementById('delivery-container').style.display = 'block';
        renderDeliveryStatus(data.status || 'pending');
    }

    function renderDeliveryStatus(status) {
        const strip = document.getElementById('d-status-container');
        const txt   = document.getElementById('d-status-text');

        if (status === 'delivered') {
            strip.className = 'status-strip success';
            txt.textContent = '✅ Delivered Successfully';
            hide('d-pickup-section'); hide('d-received-section');
        } else if (status === 'cancelled') {
            strip.className = 'status-strip danger';
            txt.textContent = '❌ Delivery Cancelled';
            hide('d-pickup-section'); hide('d-received-section');
        } else if (status === 'inTransit') {
            strip.className = 'status-strip transit';
            txt.textContent = '🚐 In Transit – Awaiting delivery to receiver';
            hide('d-pickup-section'); show('d-received-section');
        } else {
            strip.className = 'status-strip pending';
            txt.textContent = '⏳ Pending – Awaiting pickup confirmation';
            show('d-pickup-section'); hide('d-received-section');
        }
    }

    // ── DELIVERY ACTIONS ───────────────────────────────────────────────
    async function confirmDeliveryPickup() {
        const pin = document.getElementById('d-conductor-pin-pickup').value;
        if (!pin)              { alert('Please enter the conductor PIN'); return; }
        if (pin !== CONDUCTOR_PIN) { alert('Invalid PIN.'); return; }

        const btn = document.getElementById('d-pickup-btn');
        btn.disabled = true; btn.textContent = 'Processing…';
        try {
            await db.collection('document_deliveries').doc(deliveryDocId).update({
                status: 'inTransit',
                pickedUpAt: firebase.firestore.FieldValue.serverTimestamp(),
                pickedUpBy: 'conductor'
            });
            renderDeliveryStatus('inTransit');
            $set('d-success-text', '✅ Document picked up! Status updated to In-Transit.');
            show('d-success-container');
        } catch (err) {
            alert('Error: ' + err.message);
            btn.disabled = false;
            btn.textContent = '📦 Confirm Pickup (Mark In-Transit)';
        }
    }

    async function confirmDeliveryReceived() {
        const pin = document.getElementById('d-conductor-pin-received').value;
        if (!pin)              { alert('Please enter the conductor PIN'); return; }
        if (pin !== CONDUCTOR_PIN) { alert('Invalid PIN.'); return; }

        const btn = document.getElementById('d-received-btn');
        btn.disabled = true; btn.textContent = 'Processing…';
        try {
            await db.collection('document_deliveries').doc(deliveryDocId).update({
                status: 'delivered',
                deliveredAt: firebase.firestore.FieldValue.serverTimestamp(),
                deliveredBy: 'conductor'
            });
            renderDeliveryStatus('delivered');
            $set('d-success-text', '✅ Document delivered to receiver successfully!');
            show('d-success-container');
        } catch (err) {
            alert('Error: ' + err.message);
            btn.disabled = false;
            btn.textContent = '✅ Confirm Delivered to Receiver';
        }
    }

    // ── DEMO MODES ─────────────────────────────────────────────────────
    function loadDemoBooking() {
        ticketId   = 'DEMO_BOOKING_001';
        ticketData = {
            eTicketId: 'ET-DEMO0001',
            passengerDetails: {
                name: 'Juan Dela Cruz',
                regularSeats: ['A1'],
                discountedSeats: ['A2']
            },
            seatIds: ['A1', 'A2'],
            origin: 'General Santos', destination: 'Glan',
            vanPlateNumber: 'ABC-1234', vanDriverName: 'Pedro Santos',
            departureTime: { seconds: Math.floor(Date.now() / 1000) },
            bookingStatus: 'confirmed',
            paymentMethod: 'GCash', paymentStatus: 'paid',
            basePrice: 280, discountAmount: 20, totalAmount: 295
        };
        renderBookingTicket(ticketData);
    }

    function loadDemoDelivery() {
        deliveryDocId = 'DEMO_DELIVERY_001';
        deliveryData  = {
            origin: 'General Santos', destination: 'Glan',
            senderName: 'Maria Santos',  senderContact: '+63 912 111 2222',
            receiverName: 'Jose Reyes',  receiverContact: '+63 917 333 4444',
            documentType: 'contract',
            documentTypeNote: 'Signed copy for filing',
            createdAt: { seconds: Math.floor(Date.now() / 1000) },
            vanPlateNumber: 'XYZ-5678', vanDriverName: 'Carlos Aquino',
            paymentMethod: 'GCash', paymentStatus: 'paid', paymentAmount: 115,
            status: 'pending'
        };
        renderDeliveryTicket(deliveryData);
    }

    // ── HELPERS ────────────────────────────────────────────────────────
    function $set(id, val) { document.getElementById(id).textContent = val; }
    function show(id) { document.getElementById(id).style.display = 'block'; }
    function hide(id) { document.getElementById(id).style.display = 'none'; }
    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    // Enter key support
    document.getElementById('conductor-pin')
        .addEventListener('keypress', e => { if (e.key === 'Enter') confirmTicket(); });
    document.getElementById('conductor-pin-onboard')
        .addEventListener('keypress', e => { if (e.key === 'Enter') markAsOnboard(); });
    document.getElementById('d-conductor-pin-pickup')
        .addEventListener('keypress', e => { if (e.key === 'Enter') confirmDeliveryPickup(); });
    document.getElementById('d-conductor-pin-received')
        .addEventListener('keypress', e => { if (e.key === 'Enter') confirmDeliveryReceived(); });

    window.addEventListener('load', () => setTimeout(loadTicketInfo, 100));
</script>
</body>
</html>
